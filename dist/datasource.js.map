{"version":3,"sources":["datasource.js"],"names":["Object","defineProperty","exports","value","NGSIDatasource","undefined","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","key","Constructor","protoProps","staticProps","prototype","_lodash","require","_lodash2","_interopRequireDefault","obj","__esModule","default","_classCallCheck","instance","TypeError","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","basicAuth","query","options","promises","buildQueryParameters","targets","filter","t","hide","console","log","data","targetArray","split","myType","myTarget","myProperty","maxDataPoints","rangeFrom","Date","range","from","toISOString","rangeTo","to","push","doRequest","method","Promise","all","then","results","returnArray","queryResponse","r","returnObject","datapoints","contextElement","contextResponses","values","attributes","id","v","time","timeSplit","unixTime","datapointArray","recvTime","getTime","attrValue","rowArray","_r","_contextElement","_returnObject","columns","text","rows","_v","row","geohashLength","geohash","char_list","charAt","Math","floor","random","testDatasource","response","status","message","title","annotationQuery","replace","annotation","datasource","enable","iconColor","rangeRaw","result","metricFindQuery","mode","pattern","queryURL","n","mapToTextValue","map","d","isObject","datasourceRequest","_this","scopedVars","refId","encodeGeoHash","lat","lon","precision","p","hash","posn","decodeGeohash","Number","isNaN","Error","base32","idx","bit","evenBit","latMin","latMax","lonMin","lonMax","lonMid","latMid","toLowerCase","chr","indexOf","bitN","bounds","sw","ne","toFixed","LN10"],"mappings":"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","file":"datasource.js","sourcesContent":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n    value: true\n});\nexports.NGSIDatasource = undefined;\n\nvar _createClass = function () {\n    function defineProperties(target, props) {\n        for (var i = 0; i < props.length; i++) {\n            var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if (\"value\" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);\n        }\n    }return function (Constructor, protoProps, staticProps) {\n        if (protoProps) defineProperties(Constructor.prototype, protoProps);if (staticProps) defineProperties(Constructor, staticProps);return Constructor;\n    };\n}();\n\nvar _lodash = require('lodash');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nfunction _interopRequireDefault(obj) {\n    return obj && obj.__esModule ? obj : { default: obj };\n}\n\nfunction _classCallCheck(instance, Constructor) {\n    if (!(instance instanceof Constructor)) {\n        throw new TypeError(\"Cannot call a class as a function\");\n    }\n}\n\nvar NGSIDatasource = exports.NGSIDatasource = function () {\n    function NGSIDatasource(instanceSettings, $q, backendSrv, templateSrv) {\n        _classCallCheck(this, NGSIDatasource);\n\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n        this.q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n        this.withCredentials = instanceSettings.withCredentials;\n        this.headers = { 'Content-Type': 'application/json', \"fiware-servicepath\": \"/\" };\n        if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n            this.headers['Authorization'] = instanceSettings.basicAuth;\n        }\n    }\n\n    _createClass(NGSIDatasource, [{\n        key: 'query',\n        value: function query(options) {\n            var promises = [];\n            var query = this.buildQueryParameters(options);\n            query.targets = query.targets.filter(function (t) {\n                return !t.hide;\n            });\n\n            if (query.targets.length < 1) {\n                console.log(\"no data for this panel\");\n                return { data: [] };\n            }\n\n            for (var t in query.targets) {\n                // Get data from timeserie and table response\n                var targetArray = query.targets[t].target.split(\".\");\n                var myType = targetArray[0];\n                var myTarget = targetArray[1];\n                var myProperty = targetArray[2];\n                var maxDataPoints = query.maxDataPoints;\n                if (maxDataPoints === 1) {\n                    maxDataPoints = 1250;\n                }\n                if (query.targets[t].target !== undefined && query.targets[t].target !== \"select entity\") {\n                    var rangeFrom = new Date(query.range.from).toISOString();\n                    var rangeTo = new Date(query.range.to).toISOString();\n\n                    promises.push(this.doRequest({\n                        url: this.url + \"/v1/contextEntities/type/\" + myType + \"/id/\" + myTarget + \"/attributes/\" + myProperty + \"?lastN=\" + maxDataPoints + \"&dateFrom=\" + rangeFrom + \"&dateTo=\" + rangeTo,\n                        method: 'GET'\n                    }));\n                } else {\n                    return { data: [] };\n                }\n            }\n\n            return Promise.all(promises).then(function (results) {\n                var returnArray = [];\n                var queryResponse = {};\n                queryResponse.data = [];\n\n                if (query.targets[0].type === \"timeserie\") {\n                    // Timeseries format\n                    for (var r in results) {\n                        var returnObject = {};\n                        returnObject.datapoints = [];\n\n                        var contextElement = results[r].data.contextResponses[0].contextElement;\n                        var values = contextElement.attributes[0].values;\n                        returnObject.target = contextElement.attributes[0].name + \" (\" + contextElement.type + \": \" + contextElement.id + \")\";\n\n                        for (var v in values) {\n                            var time = void 0,\n                                timeSplit = void 0,\n                                unixTime = void 0;\n                            var datapointArray = [];\n                            time = values[v].recvTime;\n                            time += \"Z\";\n                            timeSplit = time.split(' ');\n                            time = timeSplit[0] + \"T\" + timeSplit[1];\n                            unixTime = new Date(time).getTime();\n                            datapointArray.push(values[v].attrValue);\n                            datapointArray.push(unixTime);\n                            returnObject.datapoints.push(datapointArray);\n                        }\n                        returnArray.push(returnObject);\n                    }\n                } else if (query.targets[0].type === \"table\") {\n                    // Table format (used for World Map Plugin)\n                    var rowArray = [];\n\n                    for (var _r in results) {\n                        var _contextElement = results[_r].data.contextResponses[0].contextElement.attributes[0].values;\n                        var _returnObject = {};\n                        _returnObject.type = \"table\";\n                        _returnObject.columns = [{ text: \"Time\" }, { text: \"Value\" }, { text: \"geohash\" }];\n                        _returnObject.rows = [];\n\n                        // TODO Make query for geolocation attribute here\n\n                        // create one row per result\n                        for (var _v in _contextElement) {\n                            var row = [];\n                            row.push(_contextElement[_v].recvTime);\n                            row.push(_contextElement[_v].attrValue);\n\n                            // TODO Match recvTime with geolocation attribute and copy geohash\n\n                            // Generate random geohash\n                            var geohashLength = 12;\n                            var geohash = \"\";\n                            var char_list = \"abcdefghijklmnopqrstuvwxyz0123456789\";\n                            for (var i = 0; i < geohashLength; i++) {\n                                geohash += char_list.charAt(Math.floor(Math.random() * char_list.length));\n                            }\n\n                            row.push(geohash);\n                            rowArray.push(row);\n                        }\n                        _returnObject.rows = rowArray;\n                        returnArray.push(_returnObject);\n                    }\n                }\n                queryResponse.data = returnArray;\n                return queryResponse;\n            });\n        }\n    }, {\n        key: 'testDatasource',\n        value: function testDatasource() {\n            return this.doRequest({\n                url: this.url + \"/v2/entities\",\n                method: 'GET'\n            }).then(function (response) {\n                if (response.status === 200) {\n                    return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n                } else {\n                    return { status: \"success\", message: \"COMET URL cannot be automatically tested, sorry.\", title: \"No connection test possible\" };\n                }\n            });\n        }\n    }, {\n        key: 'annotationQuery',\n        value: function annotationQuery(options) {\n            var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n            var annotationQuery = {\n                range: options.range,\n                annotation: {\n                    name: options.annotation.name,\n                    datasource: options.annotation.datasource,\n                    enable: options.annotation.enable,\n                    iconColor: options.annotation.iconColor,\n                    query: query\n                },\n                rangeRaw: options.rangeRaw\n            };\n\n            return this.doRequest({\n                url: this.url + '/annotations',\n                method: 'POST',\n                data: annotationQuery\n            }).then(function (result) {\n                return result.data;\n            });\n        }\n    }, {\n        key: 'metricFindQuery',\n        value: function metricFindQuery(mode, pattern) {\n            // Pre-fills data types\n            var queryURL = void 0;\n            if (mode === \"listTypes\") {\n                queryURL = \"/v2/types\";\n                return this.doRequest({\n                    url: this.url + queryURL,\n                    method: 'GET'\n                }).then(function (response) {\n                    if (response.status === 200) {\n                        var returnArray = [];\n                        for (var n = 0; n < response.data.length; n++) {\n                            if (response.data[n].type !== \"\" && response.data[n].type !== undefined) {\n                                var returnObject = {};\n                                returnObject.text = response.data[n].type;\n                                returnObject.value = response.data[n].type;\n                                returnArray.push(returnObject);\n                            }\n                        }\n                        return returnArray;\n                    }\n                });\n            } else if (mode === \"listIDs\" && pattern !== undefined && pattern !== \"select entity\") {\n                queryURL = \"/v2/entities?type=\" + pattern;\n                return this.doRequest({\n                    url: this.url + queryURL,\n                    method: 'GET'\n                }).then(function (response) {\n                    if (response.status === 200) {\n                        var returnArray = [];\n                        for (var n = 0; n < response.data.length; n++) {\n                            if (response.data[n].id !== \"\" && response.data[n].id !== undefined) {\n                                var returnObject = {};\n                                returnObject.text = response.data[n].id;\n                                returnObject.value = response.data[n].type + \".\" + response.data[n].id;\n                                returnArray.push(returnObject);\n                            }\n                        }\n                        return returnArray;\n                    }\n                });\n            }\n        }\n    }, {\n        key: 'mapToTextValue',\n        value: function mapToTextValue(result) {\n            return _lodash2.default.map(result.data, function (d, i) {\n                if (d && d.text && d.value) {\n                    return { text: d.text, value: d.value };\n                } else if (_lodash2.default.isObject(d)) {\n                    return { text: d, value: i };\n                }\n                return { text: d, value: d };\n            });\n        }\n    }, {\n        key: 'doRequest',\n        value: function doRequest(options) {\n            options.withCredentials = this.withCredentials;\n            options.headers = this.headers;\n\n            return this.backendSrv.datasourceRequest(options);\n        }\n    }, {\n        key: 'buildQueryParameters',\n        value: function buildQueryParameters(options) {\n            var _this = this;\n\n            //remove placeholder targets\n            options.targets = _lodash2.default.filter(options.targets, function (target) {\n                return target.target !== 'select entity';\n            });\n\n            var targets = _lodash2.default.map(options.targets, function (target) {\n                return {\n                    target: _this.templateSrv.replace(target.target, options.scopedVars, 'regex'),\n                    refId: target.refId,\n                    hide: target.hide,\n                    type: target.type || 'timeserie'\n                };\n            });\n\n            options.targets = targets;\n\n            return options;\n        }\n    }, {\n        key: 'encodeGeoHash',\n        value: function encodeGeoHash(lat, lon, precision) {\n            if (typeof precision === 'undefined') {\n                // refine geohash until it matches precision of supplied lat/lon\n                for (var p = 1; p <= 12; p++) {\n                    var hash = this.encodeGeoHash(lat, lon, p);\n                    var posn = this.decodeGeohash(hash);\n                    if (posn.lat === lat && posn.lon === lon) {\n                        return hash;\n                    }\n                }\n                precision = 12; // set to maximum\n            }\n\n            lat = Number(lat);\n            lon = Number(lon);\n            precision = Number(precision);\n\n            if (isNaN(lat) || isNaN(lon) || isNaN(precision)) throw new Error('Invalid geoposition');\n\n            var base32 = '0123456789bcdefghjkmnpqrstuvwxyz';\n            var idx = 0; // index into base32 map\n            var bit = 0; // each char holds 5 bits\n            var evenBit = true;\n            var geohash = '';\n\n            var latMin = -90,\n                latMax = 90;\n            var lonMin = -180,\n                lonMax = 180;\n\n            while (geohash.length < precision) {\n                if (evenBit) {\n                    // bisect E-W longitude\n                    var lonMid = (lonMin + lonMax) / 2;\n                    if (lon >= lonMid) {\n                        idx = idx * 2 + 1;\n                        lonMin = lonMid;\n                    } else {\n                        idx = idx * 2;\n                        lonMax = lonMid;\n                    }\n                } else {\n                    // bisect N-S latitude\n                    var latMid = (latMin + latMax) / 2;\n                    if (lat >= latMid) {\n                        idx = idx * 2 + 1;\n                        latMin = latMid;\n                    } else {\n                        idx = idx * 2;\n                        latMax = latMid;\n                    }\n                }\n                evenBit = !evenBit;\n\n                if (++bit === 5) {\n                    // 5 bits gives us a character: append it and start over\n                    geohash += base32.charAt(idx);\n                    bit = 0;\n                    idx = 0;\n                }\n            }\n            return geohash;\n        }\n    }, {\n        key: 'decodeGeohash',\n        value: function decodeGeohash(geohash) {\n            var base32 = '0123456789bcdefghjkmnpqrstuvwxyz';\n\n            if (geohash.length === 0) throw new Error('Invalid geohash');\n            geohash = geohash.toLowerCase();\n\n            var evenBit = true;\n            var latMin = -90,\n                latMax = 90;\n            var lonMin = -180,\n                lonMax = 180;\n\n            for (var i = 0; i < geohash.length; i++) {\n                var chr = geohash.charAt(i);\n                var idx = base32.indexOf(chr);\n                if (idx === -1) throw new Error('Invalid geohash');\n\n                for (var n = 4; n >= 0; n--) {\n                    var bitN = idx >> n & 1;\n                    if (evenBit) {\n                        // longitude\n                        var lonMid = (lonMin + lonMax) / 2;\n                        if (bitN === 1) {\n                            lonMin = lonMid;\n                        } else {\n                            lonMax = lonMid;\n                        }\n                    } else {\n                        // latitude\n                        var latMid = (latMin + latMax) / 2;\n                        if (bitN === 1) {\n                            latMin = latMid;\n                        } else {\n                            latMax = latMid;\n                        }\n                    }\n                    evenBit = !evenBit;\n                }\n            }\n\n            var bounds = {\n                sw: { lat: latMin, lon: lonMin },\n                ne: { lat: latMax, lon: lonMax }\n            };\n\n            latMin = bounds.sw.lat;\n            lonMin = bounds.sw.lon;\n            latMax = bounds.ne.lat;\n            lonMax = bounds.ne.lon;\n\n            // cell centre\n            var lat = (latMin + latMax) / 2;\n            var lon = (lonMin + lonMax) / 2;\n\n            // round to close to centre without excessive precision: ⌊2-log10(Δ°)⌋ decimal places\n            lat = lat.toFixed(Math.floor(2 - Math.log(latMax - latMin) / Math.LN10));\n            lon = lon.toFixed(Math.floor(2 - Math.log(lonMax - lonMin) / Math.LN10));\n\n            return { lat: Number(lat), lon: Number(lon) };\n        }\n    }]);\n\n    return NGSIDatasource;\n}();\n//# sourceMappingURL=datasource.js.map\n//# sourceMappingURL=datasource.js.map"]}